name: SonarCloud Analysis

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  build:
    name: Build, Test & Analyze
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Setup .NET
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      # 3. Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # 4. Build solution
      - name: Build
        run: dotnet build --no-restore --configuration Release

      # 5. Run tests con cobertura (si no tienes tests igual funciona)
      - name: Run tests with coverage
        run: |
          dotnet test --no-build --configuration Release \
            /p:CollectCoverage=true \
            /p:CoverletOutput=TestResults/ \
            /p:CoverletOutputFormat=cobertura

      # 6. Install ReportGenerator (LOCAL)
      - name: Install ReportGenerator (local)
        run: dotnet tool install --tool-path .reportgenerator dotnet-reportgenerator-globaltool

      # 7. Generate coverage report in LCOV format
      - name: Generate coverage report
        run: |
          ./.reportgenerator/reportgenerator \
            "-reports:**/coverage.cobertura.xml" \
            "-targetdir:coveragereport" \
            "-reporttypes:lcov"

      # 8. SonarCloud Scan
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=Alejandro598_ApiPelicula
            -Dsonar.organization=alejandro598
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.cs.opencover.reportsPaths=**/coveragereport/lcov.info
            -Dsonar.coverage.exclusions=**/wwwroot/**
